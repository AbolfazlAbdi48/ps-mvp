{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Doozbin{% endblock %}</title>
    <meta name="description" content="تجربه نسل بعدی بازی‌های موبایل با واقعیت افزوده">

    <!-- Fonts: Vazirmatn for Persian -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://ar.doozbin.com/teh-ar/unity-build/TemplateData/style.css">
    <link rel="manifest" href="{% static 'manifest.json' %}">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Design System Variables */
        :root {
            --background: 240 10% 6%;
            --foreground: 210 100% 98%;
            --card: 240 8% 10%;
            --card-foreground: 210 100% 98%;
            --primary: 200 100% 60%;
            --primary-foreground: 240 10% 6%;
            --secondary: 280 80% 65%;
            --secondary-foreground: 240 10% 6%;
            --muted: 240 8% 18%;
            --muted-foreground: 210 20% 60%;
            --accent: 180 100% 55%;
            --accent-foreground: 240 10% 6%;
            --destructive: 0 84% 60%;
            --destructive-foreground: 210 100% 98%;
            --border: 240 10% 20%;
            --neon-glow: 200 100% 60%;
            --cyber-purple: 280 80% 65%;
            --electric-cyan: 180 100% 55%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.5;
            direction: rtl;
            text-align: right;
        }

        .font-rajdhani {
            font-family: 'Vazirmatn', sans-serif;
        }

        /* Page Management */
        .page {
            display: none;
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        .page.active {
            display: block;
        }

        /* Animations */
        @keyframes fade-in {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow-pulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 20px hsl(var(--neon-glow) / 0.6);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 0 30px hsl(var(--neon-glow) / 0.8);
            }
        }

        @keyframes slide-in {
            0% {
                opacity: 0;
                transform: translateX(20px); /* changed for RTL feel */
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.6s ease-out;
        }

        .animate-glow-pulse {
            animation: glow-pulse 2s ease-in-out infinite;
        }

        .animate-slide-in {
            animation: slide-in 0.4s ease-out;
        }

        /* Gradients */
        .bg-gradient-hero {
            background: linear-gradient(180deg, hsl(240 10% 6%) 0%, hsl(240 10% 10%) 100%);
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%));
        }

        .bg-gradient-glow {
            background: radial-gradient(circle at center, hsl(200 100% 60% / 0.15), transparent 70%);
        }

        .bg-clip-text {
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glassmorphism */
        .backdrop-blur-glass {
            backdrop-filter: blur(12px);
        }

        /* Shadows */
        .shadow-glow-sm {
            box-shadow: 0 0 20px hsl(var(--neon-glow) / 0.3);
        }

        .shadow-glow-md {
            box-shadow: 0 0 40px hsl(var(--neon-glow) / 0.4);
        }

        /* Custom Scrollbar */
        .scroll-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: hsl(var(--primary) / 0.3) transparent;
        }

        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: hsl(var(--primary) / 0.3);
            border-radius: 3px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--primary) / 0.5);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .btn-neon {
            background: linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%));
            color: hsl(var(--primary-foreground));
            box-shadow: 0 0 40px hsl(var(--neon-glow) / 0.4);
        }

        .btn-neon:hover {
            opacity: 0.9;
            box-shadow: 0 0 60px hsl(var(--neon-glow) / 0.6);
        }

        .btn-glass {
            background: hsl(var(--card) / 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid hsl(var(--primary) / 0.2);
            color: hsl(var(--foreground));
        }

        .btn-glass:hover {
            background: hsl(var(--card) / 0.6);
            border-color: hsl(var(--primary) / 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid hsl(var(--primary) / 0.3);
            color: hsl(var(--foreground));
        }

        .btn-outline:hover {
            background: hsl(var(--primary) / 0.1);
            border-color: hsl(var(--primary) / 0.5);
        }

        /* Card Styles */
        .card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--primary) / 0.2);
            border-radius: 1rem;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: hsl(var(--primary) / 0.4);
            transform: scale(1.02);
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 0.375rem;
            font-family: 'Vazirmatn', sans-serif;
        }

        .badge-live {
            background: hsl(var(--electric-cyan));
            color: hsl(var(--primary-foreground));
            box-shadow: 0 0 20px hsl(var(--electric-cyan) / 0.5);
        }

        .badge-starting {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        /* Input Styles */
        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--primary) / 0.2);
            border-radius: 0.5rem;
            color: hsl(var(--foreground));
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 20px hsl(var(--primary) / 0.3);
        }

        /* OTP Input */
        .otp-input {
            width: 3.5rem;
            height: 3.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Vazirmatn', sans-serif;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.75rem;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background-color: hsl(var(--muted));
            transition: 0.4s;
            border-radius: 1.75rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            right: 0.25rem;
            bottom: 0.25rem;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%));
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(-1.25rem);
        }

        /* Small RTL adjustments for absolute positioned badges/icons */
        .abs-top-start {
            top: 0.75rem;
            right: 0.75rem;
        }

        .abs-avatar-status {
            bottom: 0;
            left: 0;
        }

        /* swap to left for RTL */
        .card-img-badge {
            top: 0.75rem;
            right: 0.75rem;
        }

        .lead-cta {
            text-align: right;
        }

        /* Tiny responsive tweak for RTL scroll container */
        @media (max-width: 768px) {
            .scroll-container {
                -webkit-overflow-scrolling: touch;
            }
        }

        .ctaDiv {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 30%;
            z-index: 99;
        }
    </style>

    <script>
        // Tailwind Config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))',
                        'card-foreground': 'hsl(var(--card-foreground))',
                        primary: 'hsl(var(--primary))',
                        'primary-foreground': 'hsl(var(--primary-foreground))',
                        secondary: 'hsl(var(--secondary))',
                        'secondary-foreground': 'hsl(var(--secondary-foreground))',
                        muted: 'hsl(var(--muted))',
                        'muted-foreground': 'hsl(var(--muted-foreground))',
                        accent: 'hsl(var(--accent))',
                        'accent-foreground': 'hsl(var(--accent-foreground))',
                        destructive: 'hsl(var(--destructive))',
                        'destructive-foreground': 'hsl(var(--destructive-foreground))',
                        border: 'hsl(var(--border))',
                        'neon-cyan': 'hsl(var(--electric-cyan))',
                    }
                }
            }
        }
    </script>
    {% block css_code %}

    {% endblock %}
</head>
<body>

{% block main %}
    <!-- Game Page (Original Home Design) -->
    <div id="game-page" class="page active">
        <div class="p-6 space-y-8">
            <!-- Hero Section -->
            <div class="relative h-[60vh] min-h-[400px] rounded-3xl overflow-hidden bg-gradient-hero animate-fade-in">
                <div class="absolute inset-0 bg-cover bg-center opacity-60"
                     style="background-image: url({% static 'ui/bg/ar-hero.jpg' %});"></div>
                <div class="absolute inset-0 bg-gradient-glow"></div>

                <div class="relative h-full flex flex-col justify-end p-8 md:p-12">
                    <div class="max-w-2xl">
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-glass border border-primary/30 mb-4"
                             style="background: hsl(var(--card) / 0.4);">
                            <div class="w-2 h-2 rounded-full animate-glow-pulse"
                                 style="background: hsl(var(--electric-cyan));"></div>
                            <span class="text-sm font-medium">بازی دوزبین</span>
                        </div>

                        <h1 class="text-5xl md:text-7xl font-rajdhani font-bold mb-4 bg-gradient-primary bg-clip-text">
                            نبرد واقعیت افزوده
                        </h1>

                        <p class="text-lg md:text-xl text-muted-foreground mb-8 max-w-xl lead-cta">
                            وارد آیندهٔ بازی‌ها شوید. در مکان‌های واقعی جستجو کنید و جایزه ببرید.
                        </p>

                        <div class="flex flex-wrap gap-4">
                            <button onclick="navigateTo('ar-game-page')" class="btn btn-neon">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                ورود به محدوده دوزبین
                            </button>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Games Section -->
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl md:text-3xl font-rajdhani font-bold">بازی‌های در جریان</h2>
                    <span class="text-sm text-muted-foreground">1 فعال</span>
                </div>

                <div class="scroll-container pb-4">
                    <div class="flex gap-4" style="width: max-content;" onclick="navigateTo('ar-game-page')">
                        <!-- Live Game Cards -->
                        <div class="w-72 card animate-slide-in" style="flex-shrink: 0;">
                            <div class="relative h-40 rounded-t-2xl overflow-hidden"
                                 style="background: linear-gradient(to bottom right, hsl(var(--primary) / 0.2), hsl(var(--secondary) / 0.2));">
                                <img src="{% static 'ui/bg/ar-hero.jpg' %}"
                                     alt="Game" class="w-full h-full object-cover opacity-70">
                                <div class="absolute card-img-badge">
                                    <span class="badge badge-live">زنده</span>
                                </div>
                            </div>
                            <div class="p-4 space-y-3">
                                <h3 class="font-rajdhani font-semibold text-lg">ایران AR</h3>
                                <div class="flex items-center justify-between text-sm text-muted-foreground">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                        </svg>
                                        <span>۲۴ بازیکن</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <span>۱۵۶</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coming Soon Section -->
            <section class="space-y-4">
                <h2 class="text-2xl font-rajdhani font-bold">به‌زودی</h2>
                <div class="space-y-4">
                    <div class="relative rounded-2xl overflow-hidden p-6 border backdrop-blur-glass card">
                        <div class="absolute inset-0 bg-gradient-glow opacity-0 transition-opacity"></div>
                        <div class="relative space-y-4">
                            <div class="flex items-start justify-between">
                                <div class="space-y-2">
                                    <h3 class="font-rajdhani font-bold text-2xl">تورنمنت لانه اژدها</h3>
                                    <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <span>۱۵ مارس ۲۰۲۴</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-secondary/20 border border-secondary/30">
                                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor"
                                         viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                    <span class="text-sm font-semibold text-secondary">۵۰۰۰ جم</span>
                                </div>
                            </div>
                            <p class="text-muted-foreground">
                                در غارهای اسرارآمیز مبارزه کنید و گنج افسانه‌ای اژدها را از آن خود کنید.
                            </p>
                            <button class="btn btn-outline w-full">اطلاع‌رسانی</button>
                        </div>
                    </div>

                    <div class="relative rounded-2xl overflow-hidden p-6 border backdrop-blur-glass card">
                        <div class="absolute inset-0 bg-gradient-glow opacity-0 transition-opacity"></div>
                        <div class="relative space-y-4">
                            <div class="flex items-start justify-between">
                                <div class="space-y-2">
                                    <h3 class="font-rajdhani font-bold text-2xl">چمپیونشیپ نبرد شهری</h3>
                                    <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <span>۲۲ مارس ۲۰۲۴</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-secondary/20 border border-secondary/30">
                                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor"
                                         viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                    <span class="text-sm font-semibold text-secondary">۱۰۰۰۰ جم</span>
                                </div>
                            </div>
                            <p class="text-muted-foreground">
                                شهر خود را به میدان نبرد تبدیل کنید. با هم‌تیمی‌ها متحد شوید و تسلط پیدا کنید.
                            </p>
                            <button class="btn btn-outline w-full">اطلاع‌رسانی</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>


    <!-- AR Game Scene Page -->
    <div id="ar-game-page" class="page">
        <div class="ar-box" style="z-index: 10000;">

            <video id="webcam-video" muted autoplay playsinline style="width:1px;position:absolute"></video>
            <canvas id="video-canvas" style="width:100%; height:100%; object-fit:cover; position:absolute"></canvas>

            <!-- AR Access Controls -->
            <div id="startARDiv" class="ctaDiv" style="">
                <select id="chooseCamSel" style="display: none !important; opacity: 0" onchange="SelectCam()"></select>
                <p style="text-align: center; width:60vw">روی شروع بازی کلیک کن و دسترسی دوربین رو فعال کن</p>
            </div>

            <!-- Screenshot Preview -->
            <div id="screenshotDiv" style="display: none;" class="ctaDiv">
                <div style="position:relative; background-color:white; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25);">
                    <img id="screenshotImg" src="" alt="screenshot" style="width:80vw; height:80vh">
                    <button onclick="document.getElementById('screenshotDiv').style.display = 'none';"
                            style="position:absolute; transform:translateY(-100%); right:0; top:0">Close
                    </button>
                </div>
            </div>

            <!-- Error Display -->
            <div id="errorDiv" class="ctaDiv" style="display: none; background:#aaa">
                <p id="errorText" style="text-align: center; width:60vw; color:white"></p>
            </div>

            <div id="unity-container" class="unity-mobile">
                <canvas id="unity-canvas"
                        style="width: 100%; height: 100%; background: #0000; z-index: -99;"></canvas>
                <div id="unity-loading-bar">
                    <div id="unity-logo"></div>
                    <div id="unity-progress-bar-empty">
                        <div id="unity-progress-bar-full"></div>
                    </div>
                </div>
                <canvas id="video-canvas"></canvas>
            </div>

        </div>
        <div class="relative min-h-screen overflow-hidden">

            <!-- Simulated AR Camera Background -->
            <div class="absolute inset-0 bg-gradient-hero" style="opacity: 0.5;">
                <!-- Animated blur effect to simulate camera -->
                <div class="absolute inset-0 animate-glow-pulse"
                     style="opacity: 0.5;background: radial-gradient(ellipse at center, hsl(var(--primary) / 0.15) 0%, transparent 50%);"></div>

                <!-- Grid overlay for AR effect -->
                <div class="absolute inset-0 opacity-10"
                     style="background-image: linear-gradient(hsl(var(--primary)) 1px, transparent 1px), linear-gradient(90deg, hsl(var(--primary)) 1px, transparent 1px); background-size: 50px 50px;">
                </div>
            </div>

            <!-- Floating Particles -->
            <div id="ar-particles"></div>

            <!-- AR Camera Elements -->

            <!-- Semi-transparent UI Overlay -->
            <div class="relative z-10 min-h-screen flex flex-col">
                <!-- Top Bar - Coins/Gems Counter -->
                <div class="p-6 flex justify-between items-center">
                    <div class="flex items-center gap-3 px-6 py-3 rounded-full backdrop-blur-glass border border-primary/30 shadow-glow-sm"
                         style="background: hsl(var(--card) / 0.6);">
                        <svg class="w-6 h-6 text-accent animate-glow-pulse" fill="none" stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="coin-counter"
                              class="font-rajdhani font-bold text-2xl text-foreground">{{ request.user.profile.total_score }}</span>
                    </div>

                    <!-- AR Scan indicator -->
                    <div class="px-4 py-2 rounded-full backdrop-blur-glass border border-accent/30"
                         style="background: hsl(var(--card) / 0.4);">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-accent animate-glow-pulse"></div>
                            <span class="text-sm font-medium text-accent">AR ACTIVE</span>
                        </div>
                    </div>
                </div>

                <!-- Center Area - AR Scanning Reticle -->
                <div class="flex-1 flex items-center justify-center" style="opacity: 0">
                    <div class="relative w-64 h-64">
                        <!-- Scanning reticle -->
                        <div class="absolute inset-0 border-2 border-primary/50 rounded-lg animate-glow-pulse">
                            <!-- Corner brackets -->
                            <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary rounded-tl-lg"></div>
                            <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary rounded-tr-lg"></div>
                            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary rounded-bl-lg"></div>
                            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary rounded-br-lg"></div>

                            <!-- Center crosshair -->
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                                <div class="w-4 h-4 border-2 border-accent rounded-full shadow-glow-md"></div>
                            </div>
                        </div>

                        <!-- Scanning line animation -->
                        <div class="absolute inset-0 overflow-hidden rounded-lg">
                            <div class="absolute w-full h-0.5 shadow-glow-sm"
                                 style="background: linear-gradient(to right, transparent, hsl(var(--primary)), transparent); animation: scan 2s ease-in-out infinite;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Floating Buttons -->
                <div class="p-6 flex items-end justify-between">
                    <!-- Scan Button - Bottom Right -->
                    <button onclick="StartAR()" id="startARButton"
                            class="btn btn-neon shadow-glow-md hover:shadow-glow-lg transition-all animate-glow-pulse">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        شروع بازی
                    </button>

                    <!-- Exit Button - Bottom Left -->
                    <button onclick="navigateTo('game-page')"
                            class="btn btn-glass shadow-glow-sm hover:shadow-glow-md transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        خروج از بازی
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Page -->
    <div id="leaderboard-page" class="page">
        <div class="p-6 space-y-6">
            <!-- Header -->
            <div class="text-center space-y-2 animate-fade-in">
                <h1 class="text-4xl font-rajdhani font-bold bg-gradient-primary bg-clip-text">جدول رده‌بندی</h1>
                <p class="text-muted-foreground">برترین بازیکنان امروز</p>
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 p-1 rounded-xl bg-card/40 backdrop-blur-glass border border-primary/20">
                <button class="flex-1 py-2 px-4 rounded-lg font-rajdhani font-semibold bg-gradient-primary text-primary-foreground"
                        onclick="setLeaderboard('daily', this)">
                    روزانه
                </button>
                <button class="flex-1 py-2 px-4 rounded-lg font-rajdhani font-semibold text-muted-foreground hover:text-foreground"
                        onclick="setLeaderboard('weekly', this)">
                    هفتگی
                </button>
                <button class="flex-1 py-2 px-4 rounded-lg font-rajdhani font-semibold text-muted-foreground hover:text-foreground"
                        onclick="setLeaderboard('alltime', this)">
                    همهٔ زمان‌ها
                </button>
            </div>
            <!-- Top 3 -->
            <div class="grid grid-cols-3 gap-3">
                <!-- 2nd Place -->
                <div class="card p-4 flex flex-col items-center space-y-2">
                    <div class="text-2xl">🥈</div>
                    <div class="w-12 h-12 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold">
                        SK
                    </div>
                    <div class="text-center">
                        <div class="font-semibold text-sm">سای‌کینگ</div>
                        <div class="text-xs text-secondary">۸٬۵۳۲</div>
                    </div>
                </div>

                <!-- 1st Place -->
                <div class="card p-4 flex flex-col items-center space-y-2 border-primary/40">
                    <div class="text-2xl">👑</div>
                    <div class="w-16 h-16 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold shadow-glow-md">
                        NJ
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">نینجا ایکس</div>
                        <div class="text-sm text-primary font-bold">۱۲٬۴۵۶</div>
                    </div>
                </div>

                <!-- 3rd Place -->
                <div class="card p-4 flex flex-col items-center space-y-2">
                    <div class="text-2xl">🥉</div>
                    <div class="w-12 h-12 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold">
                        CQ
                    </div>
                    <div class="text-center">
                        <div class="font-semibold text-sm">سایبرکیو</div>
                        <div class="text-xs text-accent">۷٬۸۹۱</div>
                    </div>
                </div>
            </div>

            <!-- Rest of Rankings -->
            <div class="space-y-2">
                <div class="card p-4 flex items-center justify-between hover:border-primary/40">
                    <div class="flex items-center gap-4">
                        <div class="text-xl font-rajdhani font-bold text-muted-foreground w-8">4</div>
                        <div class="w-10 h-10 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold text-sm">
                            PX
                        </div>
                        <div>
                            <div class="font-semibold">فونیکس‌آر</div>
                            <div class="text-sm text-muted-foreground">۶٬۲۳۴ امتیاز</div>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>

                <div class="card p-4 flex items-center justify-between hover:border-primary/40">
                    <div class="flex items-center gap-4">
                        <div class="text-xl font-rajdhani font-bold text-muted-foreground w-8">5</div>
                        <div class="w-10 h-10 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold text-sm">
                            ST
                        </div>
                        <div>
                            <div class="font-semibold">استورم‌تی</div>
                            <div class="text-sm text-muted-foreground">۵٬۸۹۱ امتیاز</div>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                </div>

                <div class="card p-4 flex items-center justify-between hover:border-primary/40">
                    <div class="flex items-center gap-4">
                        <div class="text-xl font-rajdhani font-bold text-muted-foreground w-8">6</div>
                        <div class="w-10 h-10 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold text-sm">
                            VN
                        </div>
                        <div>
                            <div class="font-semibold">ورتکس‌ان</div>
                            <div class="text-sm text-muted-foreground">۵٬۵۶۷ امتیاز</div>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>

                <!-- Your Rank -->
                <div class="card p-4 flex items-center justify-between border-primary/40 bg-primary/5">
                    <div class="flex items-center gap-4">
                        <div class="text-xl font-rajdhani font-bold text-primary w-8">۴۲</div>
                        <div class="w-10 h-10 rounded-full bg-gradient-primary flex items-center justify-center font-rajdhani font-bold text-sm">
                            JD
                        </div>
                        <div>
                            <div class="font-semibold">تو (JohnDoe)</div>
                            <div class="text-sm text-primary font-semibold">۱٬۲۳۴ امتیاز</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
        <div class="p-6 space-y-6">
            <!-- Header -->
            <div class="space-y-2 animate-fade-in">
                <h1 class="text-3xl font-rajdhani font-bold">تنظیمات</h1>
                <p class="text-muted-foreground">مدیریت تنظیمات شما</p>
            </div>

            <!-- Settings Sections -->
            <div class="space-y-4">
                <!-- Language -->
                <div class="space-y-3">
                    <h3 class="font-rajdhani font-bold text-lg">زبان</h3>
                    <div class="card p-4">
                        <select class="bg-transparent border-none focus:ring-0">
                            <option>فارسی</option>
                            <option>English(coming soon)</option>
                        </select>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="space-y-3">
                    <div class="space-y-3">
                        <h3 class="font-rajdhani font-bold text-lg">اعلان‌ها</h3>

                        <div class="card p-4 flex items-center justify-between opacity-50 cursor-not-allowed">
                            <div class="flex items-center gap-2">
                                <div>
                                    <div class="font-semibold">دعوت به بازی <span class="text-sm text-muted-foreground">به زودی</span>
                                    </div>
                                    <div class="text-sm text-muted-foreground">دریافت اعلان برای دعوت به بازی</div>
                                </div>
                            </div>
                            <!-- غیرفعال کردن toggle -->
                            <label class="toggle">
                                <input type="checkbox" disabled>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>


                    <div class="card p-4 flex items-center justify-between">
                        <div>
                            <div class="font-semibold">بروزرسانی تورنمنت‌ها</div>
                            <div class="text-sm text-muted-foreground">دریافت اعلان دربارهٔ تورنمنت‌ها</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="card p-4 flex items-center justify-between">
                        <div>
                            <div class="font-semibold">افکت‌های صوتی</div>
                            <div class="text-sm text-muted-foreground">فعال‌سازی صداهای درون بازی</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Account -->
                <div class="space-y-3">
                    <h3 class="font-rajdhani font-bold text-lg">حساب کاربری</h3>


                    <!-- Button -->
                    <button onclick="showModal()"
                            class="card p-4 w-full flex items-center justify-between hover:border-primary/40">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>سیاست حفظ حریم خصوصی</span>
                        </div>
                        <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>


                    <!-- Modal -->
                    <!-- Modal -->
                    <div id="myModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div class="bg-black rounded-xl p-6 w-11/12 max-w-md shadow-lg">
                            <h2 class="text-xl font-bold mb-4 text-white">قوانین</h2>
                            <p class="mb-4 text-gray-600">اینجا متن قوانین یا توضیحات مربوطه نوشته می‌شود.</p>
                            <button onclick="hideModal()" class="btn btn-neon w-full">بستن</button>
                        </div>
                    </div>


                    <button onclick="showModalInfo()"
                            class="card p-4 w-full flex items-center justify-between hover:border-primary/40">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span>شرایط استفاده</span>
                        </div>
                        <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>


                    <!-- Modal -->
                    <div id="myModalInfo"
                         class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div class="bg-black rounded-xl p-6 w-11/12 max-w-md shadow-lg">
                            <h2 class="text-xl font-bold mb-4 text-white">توضیحات بازی</h2>
                            <p class="mb-4 text-gray-600">اینجا توضیحات مربوطه نوشته می‌شود.</p>
                            <button onclick="hideModalInfo()" class="btn btn-neon w-full">بستن</button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="space-y-3">
                    <h3 class="font-rajdhani font-bold text-lg text-destructive">منطقهٔ خطر</h3>

                    <button onclick="navigateTo('language-page')"
                            class="card p-4 w-full flex items-center justify-between border-destructive/40 hover:border-destructive hover:bg-destructive/10">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="text-destructive font-semibold">خروج از حساب</span>
                        </div>
                        <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Game Page -->
    <div id="selected-game-page" class="page">
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-md space-y-8 text-center animate-fade-in">
                <!-- Empty State -->
                <div class="space-y-6">
                    <div class="inline-flex items-center justify-center w-32 h-32 rounded-3xl bg-gradient-primary/10 border border-primary/20">
                        <svg class="w-16 h-16 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                    </div>

                    <div class="space-y-2">
                        <h2 class="text-3xl font-rajdhani font-bold">بازی انتخاب نشده</h2>
                        <p class="text-muted-foreground">
                            هنوز هیچ بازی‌ای را انجام نداده‌اید. ماجراجویی AR خود را آغاز کنید!
                        </p>
                        <p class="text-sm text-muted-foreground" dir="rtl">
                            هنوز هیچ بازی انجام نداده‌اید
                        </p>
                    </div>

                    <button onclick="navigateTo('game-page')" class="btn btn-neon w-full text-lg py-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        کاوش بازی‌ها
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 border-t z-50 backdrop-blur-glass"
         style="background: hsl(var(--card) / 0.8); border-color: hsl(var(--primary) / 0.2)">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-around py-3">
                <button style="color: hsl(var(--primary));" onclick="navigateToUrl('/')" data-page="game-page"
                        class="nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-all text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                    </svg>
                    <div class="w-1 h-1 rounded-full shadow-glow-sm" style="background: hsl(var(--primary));"></div>
                </button>

                <button onclick="navigateToUrl('/auth/profile/')" data-page="profile-page"
                        class="nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-all text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </button>

                <button onclick="navigateToUrl('/api/game/v2/leaderboard/')" data-page="leaderboard-page"
                        class="nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-all text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </button>

                <button onclick="navigateToUrl('/api/game/v2/settings/')" data-page="settings-page"
                        class="nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-all text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>

                <button onclick="navigateToUrl('/api/game/v2/selected/')" data-page="selected-game-page"
                        class="nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-all text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>



    <!-- Notification Container -->
    <div id="notification"
         class="fixed top-6 right-6 text-white font-rajdhani font-medium px-5 py-3 rounded-2xl shadow-lg opacity-0 transition-all duration-500 transform translate-y-[-10px] z-50 flex items-center gap-3 backdrop-blur-md"
         style="background: linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%)); box-shadow: 0 0 20px rgba(100, 100, 255, 0.4);">
        <svg id="notification-icon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor"
             stroke-width="2"
             viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <span id="notification-text">پیام نمونه</span>
    </div>
{% endblock %}


<script src="https://ar.doozbin.com/teh-ar/unity-build/arcamera.js" type="text/javascript"></script>
<script src="https://ar.doozbin.com/teh-ar/unity-build/wtracker.js" type="text/javascript"></script>
<script src="https://ar.doozbin.com/teh-ar/unity-build/Build/tehranar.loader.js"></script>
<script>
    var initialize = async () => {
        var unityCanvas = document.querySelector("#unity-canvas");
        var videoCanvas = document.querySelector("#video-canvas");
        window.arCamera = new ARCamera(unityCanvas, videoCanvas);
        window.wTracker = new WorldTracker(arCamera);
        try {
            await wTracker.initialize("https://ar.doozbin.com/teh-ar/unity-build/opencv.js");
            console.log("World tracker initialized!");
        } catch (error) {
            console.error("Failed to initialize world tracker. Are you missing opencv.js?", error);
            ShowError("Failed to initialize the World Tracker.\n" + error);
            return;
        }

        await LoadWebcams();
        document.getElementById("startARButton").style.display = "block";
    }

    initialize();


    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");

    function StartAR() {
        canvas.style.width = window.innerWidth + "px";
        document.getElementById("startARButton").style.display = "none";
        canvas.style.height = window.innerHeight + "px";

        document.getElementById('startARDiv').style.display = 'none';
        createUnityInstance(document.querySelector("#unity-canvas"), {
                dataUrl: "https://ar.doozbin.com/teh-ar/unity-build/Build/tehranar.data",
                frameworkUrl: "https://ar.doozbin.com/teh-ar/unity-build/Build/tehranar.framework.js",
                codeUrl: "https://ar.doozbin.com/teh-ar/unity-build/Build/tehranar.wasm",
                //dataUrl: "{% static 'unity_build/UBuild/tehranar.data' %}",
                //frameworkUrl: "{% static 'unity_build/UBuild/tehranar.framework.js' %}",
                //codeUrl: "{% static 'unity_build/UBuild/tehranar.wasm' %}",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "DefaultCompany",
                productName: "TehranAR",
                productVersion: "0.1",
                //webglContextAttributes: { "preserveDrawingBuffer": true },
                // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
                // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
            },
            (progress) => {
                progressBarFull.style.width = 100 * progress + "%";
            }
        ).then((unityInstance) => {
            window.unityInstance = unityInstance;
            RequestWebcam();
            loadingBar.style.display = "none";
        });
        StartMotionSensors();

        //Call Start GPS here --> StartGPS();


        loadingBar.style.display = "block";
    }

    //Set Facing Mode here ('environment', 'user', '')
    window.unityFacingMode = "environment"

    window.WEBCAM_SETTINGS = {
        video: {
            facingMode: unityFacingMode,
        },
        audio: false
    };
    window.requestingForCameraPermission = false;

    async function RequestWebcam() {
        window.requestingForCameraPermission = true;
        try {
            window.webcamStream = await navigator.mediaDevices.getUserMedia(window.WEBCAM_SETTINGS);
            arCamera.setFlipped(window.WEBCAM_SETTINGS.video.facingMode == 'user');

            console.log("Webcam access granted");
            requestingForCameraPermission = false;
        } catch (err) {
            //user denied camera permission - show error panel
            console.error("getUserMedia error - ", err);
            ShowError("Failed to start the experience. Camera permission was denied");
            window.requestingForCameraPermission = false;
        }
    }

    async function StartWebcam() {
        console.log("StartWebcam")

        while (window.requestingForCameraPermission) {
            // Wait until requestingForCameraPermission becomes true.
            console.log("Waiting for permissions...");
            await new Promise(resolve => setTimeout(resolve, 100)); // Adjust the delay time as needed.
        }

        console.log("Got Permissions");

        if (window.webcamStream) {
            const video = document.querySelector("#webcam-video");
            video.srcObject = webcamStream;
            try {
                await arCamera.startWebcam(video);
                console.log("Webcam started successfully");

                window.unityInstance.SendMessage('ARCamera', 'OnStartWebcamSuccess');
            } catch (err) {
                console.error("Webcam failed to start - ", err);
                window.unityInstance.SendMessage('ARCamera', 'OnStartWebcamFail');
            }
        } else {
            console.error("Webcam failed to start - permission not yet granted");
            window.unityInstance.SendMessage('ARCamera', 'OnStartWebcamFail');
        }
    }

    async function LoadWebcams() {
        let camDevices = [];
        let devices = await navigator.mediaDevices.enumerateDevices();
        var ctr = 0;
        devices.forEach(mediaDevice => {
            if (mediaDevice.kind === 'videoinput') {

                if (window.unityFacingMode == 'environment' && !mediaDevice.label.includes('facing front')) {
                    //back cam only
                    camDevices.push(mediaDevice);
                } else if (window.unityFacingMode == 'user' && mediaDevice.label.includes('facing front')) {
                    //front cam only
                    camDevices.push(mediaDevice);
                } else {
                    //back and front
                    camDevices.push(mediaDevice);
                    console.log('pushed', mediaDevice);
                }

                ctr++;
            }
        });
        var select = document.getElementById("chooseCamSel");
        var count = 0;
        //reverse array because some Android phones can't distinguish front and back cams at first load
        //and when this happens, most of the time, front cam goes first and back cam goes last
        camDevices = camDevices.reverse();
        camDevices.forEach(mediaDevice => {
            const option = document.createElement('option');
            option.value = mediaDevice.deviceId;
            let label = `Camera ${count}`;
            if (mediaDevice.label) {
                label = mediaDevice.label
            }
            const textNode = document.createTextNode(label);
            option.appendChild(textNode);
            select.appendChild(option);
            count++;
        });
        wTracker.WEBCAM_NAME = select.options[select.selectedIndex].innerHTML;
        SelectCam(); //let's assume the normal camera is index 0 and avoid wide cameras
    }

    function SelectCam() {
        var select = document.getElementById("chooseCamSel");
        window.deviceId = select.value;
        window.WEBCAM_SETTINGS.video['deviceId'] = deviceId;
        //console.log(window.WEBCAM_SETTINGS);
        wTracker.WEBCAM_NAME = select.options[select.selectedIndex].innerHTML;

        console.log("selecting camera index [" + select.selectedIndex + "] -> " + wTracker.WEBCAM_NAME);

    }

    async function FlipCam() {
        arCamera.stopWebcam();
        window.WEBCAM_SETTINGS.video.deviceId = '';

        if (window.WEBCAM_SETTINGS.video.facingMode == 'user') {
            window.WEBCAM_SETTINGS.video.facingMode = 'environment';
            arCamera.setFlipped(false);
        } else {
            window.WEBCAM_SETTINGS.video.facingMode = 'user';
            arCamera.setFlipped(true);
        }
        window.webcamStream = await navigator.mediaDevices.getUserMedia(window.WEBCAM_SETTINGS);

        const video = document.querySelector("#webcam-video");
        video.srcObject = webcamStream;

        await arCamera.startWebcam(video);
    }

    function StartMotionSensors() {
        window.wTracker.startAngles()
            .then(() => {
                console.log("Motion sensors started");
            })
            .catch(error => {
                console.error("Failed to start motion sensors - " + error);
                ShowError("Failed to start the experience. " + error);

            });
    }

    function StartGPS() {
        window.wTracker.startGPS()
            .then((pos) => {
                console.log("GPS started", pos);
            })
            .catch(error => {
                console.error("Failed to start GPS - " + error);
                //ShowError("Failed to start GPS " + error);
            });
    }


    function ShowError(error) {
        document.getElementById("errorDiv").style.display = "flex";
        document.getElementById("errorText").innerHTML = error;
    }

    function ShowScreenshot(dataUrl) {
        document.getElementById("screenshotDiv").style.display = "flex";
        document.getElementById("screenshotImg").src = dataUrl;
        document.getElementById("screenshotImg").style.width = "80vw";
        document.getElementById("screenshotImg").style.height = 80 / window.innerWidth * window.innerHeight + "vw";
    }

    function showAnimation() {
        console.log(111)
    }

    function FromUnityToJS(i_msg) {
        console.log("--------------------------")
        console.log(i_msg)
        console.log("--------------------------")

        try {
            const messageData = JSON.parse(i_msg);

            if (messageData.type === 'startGame') {
                console.log('startGame')
                document.getElementById("ui-section").style.display = "block"
                document.getElementById("info-value").innerHTML = "{{ request.user.profile.total_score }}"

                //if ("{{ request.user.profile.total_score }}" >= "50") {
                //    qrUnityFunc();
                //} else {
                callUnityFunc();
                //}
            }

            if (messageData.type === 'qrFound') {
                fetch("/api/game/v2/play/cashable", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success:', data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                alert("بازی تمام شد ! منتظر اعلام نتایح بازی بمون...")
                window.location.reload()
            }

            if (messageData.type === 'clickedUnit') {
                const clickedUnitId = messageData.data.id;
                fetch('/api/game/v2/play/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `tapped_asset_id=${clickedUnitId}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showAnimation();
                            document.getElementById("info-value").innerHTML = data.user_score
                            if (data.user_score >= 100) {
                                // qrUnityFunc()
                                //document.getElementById('container-qr').style.display = 'block';
                                alert("تبریک، 100 حباب رو زدی، برای اعلام نتایج به گنجه اطلس مال برو!")
                                window.location.reload()
                            }
                            callUnityFunc();

                            var progressBarCount = document.getElementById("progress-line")
                            progressBarCount.width = `${data.user_score}%`
                        } else {
                            console.error("خطا در آپدیت پروفایل:", data.message);
                        }
                    })
                    .catch(error => {
                        console.error('خطا در ارتباط با بک‌اند:', error);
                    });
            }
        } catch (e) {
            console.error("خطا در تجزیه پیام JSON از یونیتی:", e);
        }
    }

</script>


<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function qrUnityFunc() {
        if (window.unityInstance && window.unityInstance.SendMessage) {
            const data = {
                "type": "qrCodeEndGame",
                "data": {
                    "id": "a7f3k9",
                    "url": "abcd",
                    "name": "Unit 1"
                }
            };

            const jsonString = JSON.stringify(data);

            window.unityInstance.SendMessage('CommunicationWithJS', 'ReceiveMessageFromJS', jsonString);

            console.log("کیوآرکد به یونیتی ارسال شد.");
        } else {
            console.error("خطا: unityInstance هنوز تعریف نشده است.");
        }
    }

    function callUnityFunc() {
        if (window.unityInstance && window.unityInstance.SendMessage) {
            const djangoData = JSON.parse('{{ unity_data|safe|escapejs }}');
            const data = {
                "type": "sendUnitsData",
                "data": [...djangoData.data]
            };

            const jsonString = JSON.stringify(data);

            window.unityInstance.SendMessage('CommunicationWithJS', 'ReceiveMessageFromJS', jsonString);

            console.log("پیام به یونیتی ارسال شد.");
        } else {
            console.error("خطا: unityInstance هنوز تعریف نشده است.");
        }
    }
</script>

<script>


    document.addEventListener("DOMContentLoaded", () => {
        const avatarImg = document.getElementById("avatar-img");
        const selector = document.getElementById("avatar-selector");
        const profileAvatar = document.getElementById("camera-btn");
        const closeBtn = document.getElementById("close-avatar-selector");

        // اگر قبلاً انتخاب شده بود، همونو نشون بده
        const saved = localStorage.getItem("selectedAvatar");
        if (saved) avatarImg.src = saved;

        // باز کردن مودال
        profileAvatar.addEventListener("click", () => {
            selector.classList.remove("hidden");
        });

        // بستن مودال
        closeBtn.addEventListener("click", () => {
            selector.classList.add("hidden");
        });

        // انتخاب آواتار جدید
        document.querySelectorAll("#avatar-selector img").forEach((img) => {
            img.addEventListener("click", () => {
                avatarImg.src = img.src;
                localStorage.setItem("selectedAvatar", img.src);
                selector.classList.add("hidden");
            });
        });
    });

    function navigateToUrl(url) {
        window.location.href = url;
    }


    // Navigation System
    function navigateTo(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // Show selected page
        const selected = document.getElementById(pageId);
        if (selected) selected.classList.add('active');

        // Show/hide nav based on page
        const nav = document.getElementById('bottom-nav');
        const pagesWithNav = ['game-page', 'profile-page', 'leaderboard-page', 'settings-page', 'selected-game-page'];
        if (pagesWithNav.includes(pageId)) {
            nav.style.display = 'block';
            navigateToSimple(pageId);
        } else {
            nav.style.display = 'none';
        }


        // Updata username


        // Scroll to top
        window.scrollTo(0, 0);
    }

    function navigateToSimple(pageId) {
        // Update nav button states
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if (btn.dataset.page === pageId) {
                btn.style.color = 'hsl(var(--primary))';
                if (!btn.querySelector('.w-1')) {
                    const dot = document.createElement('div');
                    dot.className = 'w-1 h-1 rounded-full shadow-glow-sm';
                    dot.style.background = 'hsl(var(--primary))';
                    btn.appendChild(dot);
                }
            } else {
                btn.style.color = 'hsl(var(--muted-foreground))';
                const dot = btn.querySelector('.w-1');
                if (dot) dot.remove();
            }
        });
    }

    // OTP Functions
    function sendOTP() {
        const phone = document.getElementById('phone-input').value;
        document.getElementById('phone-display').textContent = phone || '---';
        navigateTo('otp-page');
    }

    function moveToNext(input, nextIndex) {
        if (input.value.length === 1 && nextIndex < 4) {
            document.getElementById('otp-' + nextIndex).focus();
        }
    }

    function verifyOTP(event) {
        // Simple verification - just navigate to game page
        event.preventDefault();

        const otp0 = document.getElementById('otp-0').value;
        const otp1 = document.getElementById('otp-1').value;
        const otp2 = document.getElementById('otp-2').value;
        const otp3 = document.getElementById('otp-3').value;

        const fullCode = otp0 + otp1 + otp2 + otp3;
        document.getElementById('id_code').value = fullCode;
        event.target.closest('form').submit();
    }

    // Add hover effects to coming soon cards
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mouseenter', function () {
                const glow = this.querySelector('.bg-gradient-glow');
                if (glow) glow.style.opacity = '1';
            });
            card.addEventListener('mouseleave', function () {
                const glow = this.querySelector('.bg-gradient-glow');
                if (glow) glow.style.opacity = '0';
            });
        });
    });

    function setLeaderboard(type, btn) {
        // تغییر متن زیر عنوان
        const subtitle = document.querySelector('#leaderboard-page .text-center p');
        if (type === 'daily') {
            subtitle.textContent = 'برترین بازیکنان امروز';
        } else if (type === 'weekly') {
            subtitle.textContent = 'برترین بازیکنان این هفته';
        } else if (type === 'alltime') {
            subtitle.textContent = 'برترین بازیکنان';
        }

        // تغییر ظاهر تب فعال
        const tabs = btn.parentElement.querySelectorAll('button');
        tabs.forEach(b => {
            b.classList.remove('bg-gradient-primary', 'text-primary-foreground');
            b.classList.add('text-muted-foreground');
        });
        btn.classList.add('bg-gradient-primary', 'text-primary-foreground');
        btn.classList.remove('text-muted-foreground');
    }

    function showModal() {
        document.getElementById('myModal').classList.remove('hidden');
    }

    function hideModal() {
        document.getElementById('myModal').classList.add('hidden');
    }


    function showModalInfo() {
        document.getElementById('myModalInfo').classList.remove('hidden');
    }

    function hideModalInfo() {
        document.getElementById('myModalInfo').classList.add('hidden');
    }


    function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const text = document.getElementById("notification-text");
        const icon = document.getElementById("notification-icon");

        text.textContent = message;

        // مسیرهای آیکون‌های مینیمال (heroicons)
        const icons = {
            success: "M5 13l4 4L19 7", // تیک
            error: "M6 18L18 6M6 6l12 12", // ضربدر
            warning: "M12 9v2m0 4h.01M12 5a7 7 0 100 14 7 7 0 000-14z", // اخطار
            info: "M13 16h-1v-4h-1m1-4h.01M12 5a7 7 0 100 14 7 7 0 000-14z" // اطلاعات
        };

        // بازسازی کامل SVG (نه فقط innerHTML)
        icon.outerHTML = `
                <svg id="notification-icon" xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5" fill="none" stroke="currentColor"
                    stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2" d="${icons[type] || icons.info}" />
                </svg>
            `;

        // رنگ پس‌زمینه گرادیانی براساس نوع پیام
        const gradients = {
            success: "linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%))",
            error: "linear-gradient(135deg, hsl(0 80% 55%), hsl(340 80% 60%))",
            warning: "linear-gradient(135deg, hsl(40 100% 55%), hsl(20 90% 60%))",
            info: "linear-gradient(135deg, hsl(200 100% 60%), hsl(280 80% 65%))"
        };

        notification.style.background = gradients[type] || gradients.info;
        notification.style.color = "#fff";
        notification.style.backdropFilter = "blur(12px)";
        notification.style.border = "1px solid rgba(255,255,255,0.2)";
        notification.style.boxShadow = "0 0 20px rgba(0, 0, 0, 0.25)";

        // نمایش با انیمیشن نرم
        notification.classList.remove("opacity-0", "translate-y-[-10px]");
        notification.classList.add("opacity-100", "translate-y-0");

        // پنهان شدن خودکار بعد از 3 ثانیه
        setTimeout(() => {
            notification.classList.remove("opacity-100", "translate-y-0");
            notification.classList.add("opacity-0", "translate-y-[-10px]");
        }, 3000);
    }


    function saveUsername() {
        const input = document.getElementById("username-input");
        const display = document.getElementById("username-display");
        if (input && display) {
            const newUsername = input.value.trim();
            if (newUsername !== "") {
                display.textContent = newUsername;
                console.log(newUsername)
                fetch('/auth/update-nickname/', {  // آدرس ویو را تنظیم کنید
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // برای CSRF protection
                    },
                    body: JSON.stringify({
                        'username': newUsername
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Success:', data.message);
                            // انجام اقدامات بعدی
                        } else {
                            console.error('Error:', data.error);
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Network error:', error);
                        alert('Network error occurred');
                    });
            } else {
                showNotification("لطفاً نام کاربری را وارد کنید ", "error");
            }
        } else {
            console.error("المان‌ها پیدا نشدن!");
        }
    }


    // فرض کن مقدار جم فعلی کاربر اینه:
    let userGems = 1000; // برای تست مقدار رو تغییر بده

    function checkReward() {
        const modal = document.getElementById("navigateToModal");
        const title = document.getElementById("rewardTitle");
        const message = document.getElementById("rewardMessage");
        const buttons = document.getElementById("rewardButtons");

        modal.classList.remove("hidden");

        if (userGems < 1000) {
            // جم کافی نیست
            title.innerHTML = `
                    <div class="flex items-center gap-2 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3l3 7h7l-5.5 4.5L18 21l-6-3.5L6 21l1.5-6.5L2 10h7z"/>
                        </svg>
                        <span>جم کافی نیست</span>
                    </div>`;
            message.textContent = "برای دریافت جایزه باید حداقل ۱۰۰۰ جم داشته باشید.";
            buttons.innerHTML = `
                    <button class="btn btn-outline" onclick="closeModal()">بستن</button>
                `;
        } else {
            // جم کافی است
            title.innerHTML = `
                    <div class="flex items-center gap-2 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 12l-8 8-8-8 8-8 8 8z"/>
                        </svg>
                        <span>تبریک!</span>
                    </div>`;
            message.textContent = "می‌تونی جایزه‌ت رو دریافت کنی. با دریافت جایزه ۱۰۰۰ جم از حساب تو کم می‌شود.";
            buttons.innerHTML = `
                    <button class="btn btn-neon" onclick="claimReward()">دریافت جایزه</button>
                    <button class="btn btn-outline" onclick="closeModal()">بستن</button>
                `;
        }
    }

    function closeModal() {
        document.getElementById("navigateToModal").classList.add("hidden");
    }

    function claimReward() {
        if (userGems >= 1000) {
            userGems -= 1000;
            showNotification(` جایزه دریافت شد! جم فعلی: ${userGems}`, "success");
            closeModal();
        } else {
            showNotification(" جم کافی نیست!", "error");
        }
    }


</script>

{% block js_code %}

{% endblock %}
</body>
</html>
